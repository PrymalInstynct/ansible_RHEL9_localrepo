---
- name: Check if CodeReady Builder repository is enabled
  ansible.builtin.command: "subscription-manager repos --list-enabled | grep codeready-builder-for-rhel-9-x86_64-rpms"
  register: crb_repo_status
  ignore_errors: true

- name: Enable CodeReady Builder repository using RHSM
  community.general.rhsm_repository:
    name: codeready-builder-for-rhel-9-x86_64-rpms
    state: enabled
  when: crb_repo_status.rc != 0

- name: Get Docker CE Repo File checksum
  ansible.builtin.shell:
    cmd: |
      curl -sSL https://download.docker.com/linux/rhel/docker-ce.repo | openssl dgst -sha256 | cut -d " " -f 2
  register: docker_repo_checksum_result

- name: Set fact for Docker CE Repo File checksum
  ansible.builtin.set_fact:
    docker_repo_checksum: '{{ docker_repo_checksum_result.stdout }}'

- name: Enable Docker Community Edition Repo
  ansible.builtin.copy:
    src: https://download.docker.com/linux/rhel/docker-ce.repo
    dest: /etc/yum.repos.d/docker-ce.repo
    remote_src: true
    checksum: sha256:{{ docker_repo_checksum }}

- name: Install required packages
  ansible.builtin.dnf:
    name:
      - httpd
      - rsync
      - yum-utils
      - policycoreutils-python-utils
      - https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
    update_cache: true
    state: present

- name: Enable and start httpd
  ansible.builtin.systemd:
    name: httpd
    enabled: true
    state: started
